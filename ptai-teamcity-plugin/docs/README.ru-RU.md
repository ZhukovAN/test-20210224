# Инструкция по развертыванию и конфигурированию плагина Teamcity
## Установка плагина Teamcity
Для установки плагина Teamcity необходимо:
1. Войти в менеджер плагинов Teamcity (Administration - Plugins list в разделе Server administration) и нажатием на ссылку Upload plugin zip перейти в режим загрузки плагина;
2. В появившемся окне выбрать файл ptai-teamcity-plugin.zip и нажать на кнопку Save. 

После установки плагина необходимо выполнить его начальное конфигурирование.

## Начальное конфигурирование
Целью начального конфигурирования плагина Teamcity является указание URL сервера PT AI и аутентификационных данных для доступа. Указанные настройки являются глобальными для заданного экземпляра Teamcity и могут быть использованы во всех задачах сборки. <br>
Помимо глобальных, плагин поддерживает локальные настройки, задаваемые в рамках задачи сборки. Локальные настройки могут быть использованы в ситуации, когда необходимо использовать конфигурацию, отличную от заданной глобально, а права доступа недостаточны для внесения в нее изменений.<br>
Для перехода в режим управления глобальными настройками:
1. Перейдите в окно управления параметрами системы Teamcity (Administration - PT AI  в разделе Integrations);
2. В открывшемся окне заполните параметры подключения к серверу PT AI: URL и аутентификационные данные. Если сертификат сервера PT AI, использованный при развертывании, был выпущен центром сертификации, не зарегистрированным в хранилище Java-машины, используемой Teamcity, цепочка соответствующих сертификатов должна быть указана в PEM-формате в поле PT AI server trusted certificates; 
3. При необходимости можно проверить корректность введенных параметров и работоспособность сервера PT AI нажатием на кнопку Test PT AI server connection;
4. Сохраните внесенные изменения нажатием кнопки Save. 

## Включение задачи анализа кода в конвейер сборки
Для включения задачи анализа кода в конвейер сборки необходимо добавить соответствующий шаг сборки. Для этого:
1. Перейдите в желаемую задачу и нажатием на ссылку Edit Project Settings в правом верхнем углу окна войдите в режим внесения изменений;
2. В разделе Build Configurations нажатием кнопки Edit перейдите в режим редактирования конфигурации сборки и выберите пункт Build Steps у левого края окна;
3. В открывшемся окне нажатием кнопки Add build step перейдите в режим добавления шага сборки. В выпадающем списке выберите пункт PT AI. 

В настройках шага сборки необходимо указать значения следующих параметров:
- В разделе PT AI server connection settings выберите способ подключения к серверу PT AI. Для этого выберите в выпадающем списке PT AI server connection соответствующий пункт. При выборе из выпадающего списка пункта Global scope defined PT AI server config будут использованы глобальные параметры соединения, заданные в соответствии с разделом (тут ссылка на Начальное конфигурирование). При выборе в выпадающем списке Server config пункта Task scope defined PT AI server config необходимо самостоятельно заполнить URL сервера PT AI и задать аутентификационные данные, эти настройки будут являться индивидуальными для выбранной задачи сборки. Нажатием на кнопку Test PT AI server connection можно проверить корректность выполненных настроек.
- В разделе General AST settings необходимо определить базовые параметры анализа кода. При этом требуется заполнить следующие поля:
    - Scan settings type - способ, которым задаются настройки анализа. Поддерживаются два варианта: посредством PT AI Enterprise Viewer или посредством JSON-файлов настроек и политики;
    - Project name - имя проекта в PT AI Enterprise Viewer. Этот параметр доступен при выборе в поле Scan settings type пункта PT AI Viewer UI-defined settings. При проведении анализа кода настройки будут взяты из настроек соответствующего проекта, который должен существовать на момент сканирования;
    - Scan settings - параметры анализа кода, определенные в JSON-формате (тут можно дать ссылку на раздел с описанием этого формата в документации). Этот и следующий параметры доступны при указании в качестве Scan settings type значения JSON-defined settings. Поле Scan settings должно быть заполнено и содержать корректные настройки в JSON-формате;    
    - Policy - политика безопасности проекта, определенная в JSON-формате (тут можно дать ссылку на раздел с описанием этого формата в документации). Допускается оставлять значение этого поля пустым. Проверить корректность настроек можно нажатием кнопки Test JSON policy, при успешной проверке будут выведено количество правил в составе политики;
    - Fail step if SAST failed - при отмеченном флажке шаг сборки будет помечен как неуспешный при несоответствии результатов анализа кода политике безопасности, ассоциированной с проектом. Это позволяет останавливать сборку в целом и не допускать случайного развертывания уязвимого кода;
    - Fail step if SAST unstable - при отмеченном флажке шаг сборки будет помечен как неуспешный в ситуации, когда политика безопасности не нарушена, но в ходе анализа возникали второстепенные предупреждения, например, об отсутствующих зависимостях;
    - AST agent node name - метка или имя агента сканирования, предназначенного для данной задачи;
    - Verbose logging - использовать детальное протоколирование работы плагина. 
    
    Нажатием на кнопку Check AST settings можно убедиться в корректности заданных параметров
- В разделе Scan scope определяется набор файлов проекта, которые будут проанализированы. Задаются следующие параметры:
    - Files to analyse - перечень шаблонов имен файлов, включаемых в набор. Используется формат шаблонов, принятый в Ant (http://ant.apache.org/manual/dirtasks.html#patterns);
    - Exclude files - перечень шаблонов имен файлов, исключаемых из набора. Используется формат шаблонов, принятый в Ant (http://ant.apache.org/manual/dirtasks.html#patterns) ;
    - Remove prefix - префикс пути файла, который должен быть удален из итогового имени. Использование этого поля позволяет, например, избежать использования громоздких полных путей к файлам. При использовании этого параметра все файлы должны содержать указанный префикс в своем пути;
    - Pattern separator - регулярное выражение, используемое для разделения шаблонов в перечнях Files to analyse и Exclude files;
    - Use default excludes - при установке этого флажка из перечня анализируемых файлов будут автоматически удалены те, что соответствуют типовым шаблонам, например, **/.git/**, **/*~ и т.д.;
    - Flatten files - при установке этого флажка все пути к файлам будут отброшены и итоговый набор файлов будет "плоским" списком без структуры каталогов

## Результаты выполнения задачи анализа кода
По завершении шага PT AI vulnerability analysis результаты анализа кода доступны как посредством PT AI Enterprise Viewer, так и непосредственно в среде Teamcity. При этом в рабочем каталоге задачи сборки создается папка .ptai, в которую сохраняются файлы:
- report.html - стандартный HTML-отчет о результатах анализа кода;
- report.json - отчет о результатах анализа кода, представленный в машиночитаемом JSON-формате. Этот файл отчета может быть использован для автоматической обработки результатов анализа, загрузки результатов в BI-систему и т.д.;
- status.code - код возврата агента сканирования. Может быть использован для получения детальной информации о причинах возможных ошибок в ходе сканирования, например, некорректно заданных настройках, проблемах с лицензией и т.д.

